<div class="registro-formulario">
  <div class="content">
    <form [formGroup]="registroForm" (ngSubmit)="onSubmit()">
      <div class="conversation-container">
        <ng-container *ngFor="let step of conversationSteps; let i = index">
          <div *ngIf="i <= currentStepIndex">
            <!-- Assistant message -->
            <div class="assistant-message">
              {{ step.message }}
            </div>
            <!-- Instruction (if any) -->
            <div class="instruction" *ngIf="step.instruction">
              {{ step.instruction }}
            </div>
            <!-- User input -->
            <div class="user-input">
              <ng-container [ngSwitch]="step.type">
                <!-- Campo de texto -->
                <div *ngSwitchCase="'text'">
                  <mat-form-field appearance="outline" class="full-width">
                    <input
                      matInput
                      [formControlName]="step.field"
                      (blur)="onQuestionAnswered(i)"
                    />
                    <mat-error
                      *ngIf="registroForm.get(step.field)?.hasError('required')"
                    >
                      Este campo es obligatorio
                    </mat-error>
                    <mat-error
                      *ngIf="registroForm.get(step.field)?.hasError('email')"
                    >
                      Ingresa un correo electrónico válido
                    </mat-error>
                  </mat-form-field>
                </div>
                <!-- Campo de contraseña -->
                <div *ngSwitchCase="'password'">
                  <mat-form-field appearance="outline" class="full-width">
                    <input
                      matInput
                      [type]="
                        step.field === 'password'
                          ? hidePassword
                            ? 'password'
                            : 'text'
                          : hideConfirmPassword
                          ? 'password'
                          : 'text'
                      "
                      [formControlName]="step.field"
                      (blur)="onQuestionAnswered(i)"
                    />
                    <button
                      mat-icon-button
                      matSuffix
                      type="button"
                      (click)="
                        step.field === 'password'
                          ? togglePasswordVisibility()
                          : toggleConfirmPasswordVisibility()
                      "
                      [attr.aria-label]="'Mostrar u ocultar contraseña'"
                    >
                      <mat-icon>{{
                        (step.field === 'password' && hidePassword) ||
                        (step.field === 'confirmPassword' && hideConfirmPassword)
                          ? 'visibility_off'
                          : 'visibility'
                      }}</mat-icon>
                    </button>
                    <mat-error
                      *ngIf="registroForm.get(step.field)?.hasError('required')"
                    >
                      Este campo es obligatorio
                    </mat-error>
                    <mat-error
                      *ngIf="
                        registroForm.get(step.field)?.hasError(
                          'passwordStrength'
                        )
                      "
                    >
                      La contraseña no cumple con los requisitos
                    </mat-error>
                    <mat-error
                      *ngIf="
                        registroForm.hasError('passwordsMismatch') &&
                        (registroForm.get('confirmPassword')?.touched ||
                          registroForm.get('password')?.touched)
                      "
                    >
                      Las contraseñas no coinciden
                    </mat-error>
                  </mat-form-field>
                </div>
                <!-- Campo de selección -->
                <div *ngSwitchCase="'select'">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-select
                      [formControlName]="step.field"
                      (selectionChange)="onQuestionAnswered(i)"
                    >
                      <mat-option
                        *ngFor="let option of step.options"
                        [value]="option.value"
                      >
                        {{ option.label }}
                      </mat-option>
                    </mat-select>
                    <mat-error
                      *ngIf="registroForm.get(step.field)?.hasError('required')"
                    >
                      Este campo es obligatorio
                    </mat-error>
                  </mat-form-field>
                </div>
                <!-- Campo de valoración -->
                <div *ngSwitchCase="'rating'">
                  <div class="rating-container">
                    <div class="stars">
                      <button
                        *ngFor="let star of [1, 2, 3, 4, 5]"
                        type="button"
                        class="star-button"
                        (click)="setRating(step.field, star)"
                        (mouseenter)="hoverRating(step.field, star)"
                        (mouseleave)="leaveRating(step.field)"
                        [attr.aria-label]="'Calificación de ' + star + ' estrellas'"
                        [attr.aria-pressed]="star <= getRating(step.field)"
                      >
                        <mat-icon [ngClass]="{ 'active': star <= getRating(step.field) }">
                          {{ star <= getRating(step.field) ? 'star' : 'star_border' }}
                        </mat-icon>
                      </button>
                    </div>
                    <mat-error
                      *ngIf="registroForm.get(step.field)?.hasError('required')"
                    >
                      La pregunta es obligatoria
                    </mat-error>
                  </div>
                  <div (mouseleave)="onQuestionAnswered(i)"></div>
                </div>
              </ng-container>
            </div>
          </div>
        </ng-container>
        <div style="margin-bottom: 40vh;"></div>
      </div>

      <!-- Botones de Acción -->
      <div
        class="buttons"
        *ngIf="
          registroForm.valid && currentStepIndex >= conversationSteps.length
        "
      >
        <button class="volver-button" mat-button (click)="onReset()">
          Volver
        </button>
        <button
          mat-flat-button
          class="registrar-button"
          type="submit"
          [disabled]="isLoading"
        >
          <mat-icon *ngIf="!isLoading">save</mat-icon>
          <mat-progress-spinner
            *ngIf="isLoading"
            diameter="20"
            mode="indeterminate"
            color="accent"
          >
          </mat-progress-spinner>
          Registrar
        </button>
      </div>
    </form>
  </div>
</div>
